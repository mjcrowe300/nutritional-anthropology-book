<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>ch04-sugar-story.qmd</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="ch04-sugar-story_files/libs/clipboard/clipboard.min.js"></script>
<script src="ch04-sugar-story_files/libs/quarto-html/quarto.js"></script>
<script src="ch04-sugar-story_files/libs/quarto-html/popper.min.js"></script>
<script src="ch04-sugar-story_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="ch04-sugar-story_files/libs/quarto-html/anchor.min.js"></script>
<link href="ch04-sugar-story_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ch04-sugar-story_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="ch04-sugar-story_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="ch04-sugar-story_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="ch04-sugar-story_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">ch04-sugar-story.qmd</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="ch04" class="level1">
<h1>The Sugar Story</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Chapter Theme
</div>
</div>
<div class="callout-body-container callout-body">
<p>How sugar transformed from rare luxury to dietary staple—and became the single most destructive force in human dental history.</p>
</div>
</div>
<section id="sweet-poison-a-dental-detective-story" class="level2">
<h2 class="anchored" data-anchor-id="sweet-poison-a-dental-detective-story">Sweet Poison: A Dental Detective Story</h2>
<p><em>[Opening: Archaeological evidence from Caribbean sugar plantations—enslaved workers’ teeth showing unprecedented decay rates vs.&nbsp;their African ancestors]</em></p>
<section id="the-smoking-gun" class="level3">
<h3 class="anchored" data-anchor-id="the-smoking-gun">The Smoking Gun</h3>
<ul>
<li></li>
<li><p>Plantation burial grounds: dental evidence of sugar’s impact</p></li>
<li></li>
<li><p>Comparison with pre-colonial African populations</p></li>
<li></li>
<li><p>Timeline: from healthy teeth to dental disaster in one generation</p></li>
<li></li>
<li><p>The first industrial diet-disease connection</p></li>
<li></li>
</ul>
</section>
</section>
<section id="section-1-origins-of-sweetness" class="level2">
<h2 class="anchored" data-anchor-id="section-1-origins-of-sweetness">Section 1: Origins of Sweetness</h2>
<section id="the-ancient-sweet-tooth" class="level3">
<h3 class="anchored" data-anchor-id="the-ancient-sweet-tooth">The Ancient Sweet Tooth</h3>
<p><strong>Natural Sugars in Traditional Diets:</strong></p>
<ul>
<li></li>
<li><p>Honey: seasonal luxury, not daily food</p></li>
<li></li>
<li><p>Fruits: limited seasonal availability</p></li>
<li></li>
<li><p>Tree saps: maple syrup, palm sugar</p></li>
<li></li>
<li><p>Root vegetables: natural sweetness in moderation</p></li>
<li></li>
</ul>
<p><strong>Evolutionary Sweet Preference:</strong></p>
<ul>
<li></li>
<li><p>Why we crave sugar: survival advantage for calorie-dense foods</p></li>
<li></li>
<li><p>Limited availability in ancestral environments</p></li>
<li></li>
<li><p>Seasonal gorging vs.&nbsp;year-round excess</p></li>
<li></li>
<li><p>The mismatch between craving and availability</p></li>
<li></li>
</ul>
</section>
<section id="sugar-canes-journey" class="level3">
<h3 class="anchored" data-anchor-id="sugar-canes-journey">Sugar Cane’s Journey</h3>
<p><strong>From Sacred Plant to Global Commodity:</strong></p>
<ul>
<li></li>
<li><p>Origins in New Guinea: chewing fresh cane</p></li>
<li></li>
<li><p>Spread through Asia: early refining techniques</p></li>
<li></li>
<li><p>Arab world innovations: crystallization and preservation</p></li>
<li></li>
<li><p>Medieval Europe: sugar as medicine and luxury spice</p></li>
<li></li>
</ul>
</section>
</section>
<section id="section-2-the-colonial-sugar-empire" class="level2">
<h2 class="anchored" data-anchor-id="section-2-the-colonial-sugar-empire">Section 2: The Colonial Sugar Empire</h2>
<section id="plantation-economics-and-dental-destruction" class="level3">
<h3 class="anchored" data-anchor-id="plantation-economics-and-dental-destruction">Plantation Economics and Dental Destruction</h3>
<p><strong>The Triangle Trade and Teeth:</strong></p>
<ul>
<li></li>
<li><p>Caribbean sugar plantations: environmental and human cost</p></li>
<li></li>
<li><p>Enslaved populations: forced dietary changes and health impacts</p></li>
<li></li>
<li><p>European consumption explosion: from ounces to pounds per year</p></li>
<li></li>
<li><p>Colonial profits built on dental destruction</p></li>
<li></li>
</ul>
</section>
<section id="social-stratification-and-sugar" class="level3">
<h3 class="anchored" data-anchor-id="social-stratification-and-sugar">Social Stratification and Sugar</h3>
<p><strong>Sugar as Status Symbol:</strong></p>
<ul>
<li></li>
<li><p>Elite European consumption patterns</p></li>
<li></li>
<li><p>“Blackened teeth” as fashion among the wealthy</p></li>
<li></li>
<li><p>Social climbing through sugar consumption</p></li>
<li></li>
<li><p>The irony: luxury that destroyed health</p></li>
<li></li>
</ul>
<p><strong>Case Study: Tudor England</strong></p>
<ul>
<li></li>
<li><p>Queen Elizabeth’s blackened teeth</p></li>
<li></li>
<li><p>Upper class dental disaster</p></li>
<li></li>
<li><p>Sugar-paste sculptures at royal banquets</p></li>
<li></li>
<li><p>First documented sugar addiction in history</p></li>
<li></li>
</ul>
</section>
<section id="global-dental-impact" class="level3">
<h3 class="anchored" data-anchor-id="global-dental-impact">Global Dental Impact</h3>
<p><strong>The Spread of Sugar and Decay:</strong></p>
<ul>
<li></li>
<li><p>European cities: urban vs.&nbsp;rural decay rates</p></li>
<li></li>
<li><p>Colonial populations: traditional diets vs.&nbsp;sugar introduction</p></li>
<li></li>
<li><p>Trade route populations: merchants and sugar access</p></li>
<li></li>
<li><p>Documented dental health decline across cultures</p></li>
<li></li>
</ul>
</section>
</section>
<section id="section-3-industrial-sugar-revolution" class="level2">
<h2 class="anchored" data-anchor-id="section-3-industrial-sugar-revolution">Section 3: Industrial Sugar Revolution</h2>
<section id="technological-transformation" class="level3">
<h3 class="anchored" data-anchor-id="technological-transformation">Technological Transformation</h3>
<p><strong>Making Sugar Cheap:</strong></p>
<ul>
<li></li>
<li><p>Sugar beet cultivation: European sugar independence</p></li>
<li></li>
<li><p>Industrial refining: white sugar production</p></li>
<li></li>
<li><p>Transportation improvements: global distribution</p></li>
<li></li>
<li><p>Mass production: luxury becomes necessity</p></li>
<li></li>
</ul>
</section>
<section id="the-democratization-of-decay" class="level3">
<h3 class="anchored" data-anchor-id="the-democratization-of-decay">The Democratization of Decay</h3>
<p><strong>19th Century Dental Disaster:</strong></p>
<ul>
<li></li>
<li><p>Working class access to cheap sugar</p></li>
<li></li>
<li><p>Urban industrial populations: poor diet quality + sugar</p></li>
<li></li>
<li><p>Childhood dental disease epidemic</p></li>
<li></li>
<li><p>First recognition of diet-disease connection by dentists</p></li>
<li></li>
</ul>
<p><strong>Case Study: Industrial Britain</strong></p>
<ul>
<li></li>
<li><p>Factory workers’ diets and dental health</p></li>
<li></li>
<li><p>Children’s teeth in industrial cities</p></li>
<li></li>
<li><p>Early public health responses</p></li>
<li></li>
<li><p>Birth of preventive dentistry</p></li>
<li></li>
</ul>
</section>
<section id="cultural-integration" class="level3">
<h3 class="anchored" data-anchor-id="cultural-integration">Cultural Integration</h3>
<p><strong>Sugar Becomes “Normal”:</strong></p>
<ul>
<li></li>
<li><p>Tea and coffee culture: sugar as essential addition</p></li>
<li></li>
<li><p>Baking revolution: refined sugar in home cooking</p></li>
<li></li>
<li><p>Candy industry: targeted marketing to children</p></li>
<li></li>
<li><p>Holiday traditions: sugar-centered celebrations</p></li>
<li></li>
</ul>
</section>
</section>
<section id="section-4-the-science-of-sugar-and-decay" class="level2">
<h2 class="anchored" data-anchor-id="section-4-the-science-of-sugar-and-decay">Section 4: The Science of Sugar and Decay</h2>
<section id="how-sugar-destroys-teeth" class="level3">
<h3 class="anchored" data-anchor-id="how-sugar-destroys-teeth">How Sugar Destroys Teeth</h3>
<p><strong>The Bacterial Feast:</strong></p>
<ul>
<li></li>
<li><p>Streptococcus mutans: sugar’s favorite partner</p></li>
<li></li>
<li><p>Acid production and enamel dissolution</p></li>
<li></li>
<li><p>Biofilm formation: plaque as bacterial city</p></li>
<li></li>
<li><p>pH cycles: constant vs.&nbsp;intermittent sugar exposure</p></li>
<li></li>
</ul>
</section>
<section id="modern-research-revelations" class="level3">
<h3 class="anchored" data-anchor-id="modern-research-revelations">Modern Research Revelations</h3>
<p><strong>What We Now Understand:</strong></p>
<ul>
<li></li>
<li><p>Different sugars, different impacts: sucrose vs.&nbsp;fructose vs.&nbsp;glucose</p></li>
<li></li>
<li><p>Frequency vs.&nbsp;amount: timing matters more than quantity</p></li>
<li></li>
<li><p>Sticky sugars vs.&nbsp;liquid sugars: texture and retention</p></li>
<li></li>
<li><p>Hidden sugars: processed food infiltration</p></li>
<li></li>
</ul>
</section>
<section id="the-addiction-science" class="level3">
<h3 class="anchored" data-anchor-id="the-addiction-science">The Addiction Science</h3>
<p><strong>Why We Can’t Stop:</strong></p>
<ul>
<li></li>
<li><p>Dopamine pathways and sugar reward</p></li>
<li></li>
<li><p>Tolerance and escalation patterns</p></li>
<li></li>
<li><p>Withdrawal symptoms and cravings</p></li>
<li></li>
<li><p>Neurological similarities to drug addiction</p></li>
<li></li>
</ul>
</section>
</section>
<section id="section-5-cultural-resistance-and-wisdom" class="level2">
<h2 class="anchored" data-anchor-id="section-5-cultural-resistance-and-wisdom">Section 5: Cultural Resistance and Wisdom</h2>
<section id="traditional-sugar-alternatives" class="level3">
<h3 class="anchored" data-anchor-id="traditional-sugar-alternatives">Traditional Sugar Alternatives</h3>
<p><strong>Natural Sweetening Strategies:</strong></p>
<ul>
<li></li>
<li><p>Stevia: South American traditional sweetener</p></li>
<li></li>
<li><p>Monk fruit: Chinese herbal sweetening</p></li>
<li></li>
<li><p>Date syrup: Middle Eastern concentrated sweetness</p></li>
<li></li>
<li><p>Coconut palm sugar: Southeast Asian tradition</p></li>
<li></li>
</ul>
</section>
<section id="cultural-protective-practices" class="level3">
<h3 class="anchored" data-anchor-id="cultural-protective-practices">Cultural Protective Practices</h3>
<p><strong>How Some Cultures Resisted:</strong></p>
<ul>
<li></li>
<li><p>Japanese traditional diet: minimal refined sugar</p></li>
<li></li>
<li><p>Mediterranean patterns: fruit-based sweetness</p></li>
<li></li>
<li><p>Indian ayurvedic principles: sugar as medicine, not food</p></li>
<li></li>
<li><p>Indigenous American: occasional honey, seasonal fruit</p></li>
<li></li>
</ul>
</section>
<section id="modern-sugar-reduction-success-stories" class="level3">
<h3 class="anchored" data-anchor-id="modern-sugar-reduction-success-stories">Modern Sugar Reduction Success Stories</h3>
<p><strong>Population-Level Changes:</strong></p>
<ul>
<li></li>
<li><p>Scandinavian countries: public health sugar policies</p></li>
<li></li>
<li><p>Japanese longevity: low sugar consumption patterns</p></li>
<li></li>
<li><p>Mediterranean diet adherence: natural sweetness preference</p></li>
<li></li>
<li><p>Indigenous health recovery: traditional diet return</p></li>
<li></li>
</ul>
</section>
</section>
<section id="section-6-breaking-free-from-sugar" class="level2">
<h2 class="anchored" data-anchor-id="section-6-breaking-free-from-sugar">Section 6: Breaking Free from Sugar</h2>
<section id="understanding-hidden-sugars" class="level3">
<h3 class="anchored" data-anchor-id="understanding-hidden-sugars">Understanding Hidden Sugars</h3>
<p><strong>The Modern Sugar Maze:</strong></p>
<ul>
<li></li>
<li><p>56 names for sugar on ingredient lists</p></li>
<li></li>
<li><p>Processed food infiltration: savory foods with added sugars</p></li>
<li></li>
<li><p>“Healthy” foods with sugar: granola, yogurt, smoothies</p></li>
<li></li>
<li><p>Marketing deception: “natural” and “organic” sugars</p></li>
<li></li>
</ul>
</section>
<section id="practical-strategies" class="level3">
<h3 class="anchored" data-anchor-id="practical-strategies">Practical Strategies</h3>
<p><strong>Reducing Sugar Without Sacrifice:</strong></p>
<ul>
<li></li>
<li><p>Gradual reduction: retraining taste preferences</p></li>
<li></li>
<li><p>Natural sweetness: using whole fruits and spices</p></li>
<li></li>
<li><p>Traditional preparation methods: enhancing natural flavors</p></li>
<li></li>
<li><p>Community and social strategies: changing food culture</p></li>
<li></li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Breaking the Sugar Cycle
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li></li>
<li><p><strong>Read every ingredient list</strong>: Sugar hides in unexpected places</p></li>
<li></li>
<li><p><strong>Retrain your palate</strong>: Gradually reduce sweetness levels over 2-3 months</p></li>
<li></li>
<li><p><strong>Use traditional sweeteners</strong>: When needed, choose less processed options</p></li>
<li></li>
<li><p><strong>Time matters</strong>: Limit frequency of sweet foods more than total amount</p></li>
<li></li>
<li><p><strong>Natural alternatives</strong>: Satisfy sweet cravings with whole fruits and natural flavors</p></li>
<li></li>
<li><p><strong>Social strategies</strong>: Change your food environment and social food customs</p></li>
<li></li>
</ol>
</div>
</div>
</section>
</section>
<section id="the-sweet-truth" class="level2">
<h2 class="anchored" data-anchor-id="the-sweet-truth">The Sweet Truth</h2>
<p>Sugar’s journey from luxury to necessity to recognized health threat mirrors humanity’s complex relationship with technological progress. As we’ll see in our next chapter, sugar was just the beginning—the industrial revolution would transform not just sweeteners, but the entire texture, processing, and nutritional quality of human food.</p>
<hr>
<p><em>[Target length: 3,500 words]</em></p>
</section>
<section id="key-research-areas" class="level2">
<h2 class="anchored" data-anchor-id="key-research-areas">Key Research Areas:</h2>
<ul>
<li></li>
<li><p>Archaeological evidence from sugar plantation populations</p></li>
<li></li>
<li><p>Historical dental health records from sugar-consuming vs.&nbsp;non-consuming populations</p></li>
<li></li>
<li><p>Industrial revolution dietary changes and health impacts</p></li>
<li></li>
<li><p>Modern sugar addiction and dental disease research</p></li>
<li></li>
<li><p>Cultural resistance strategies and traditional sweeteners</p></li>
<li></li>
<li><p>Public health interventions and sugar reduction policies</p></li>
<li></li>
</ul>
</section>
<section id="references-to-add" class="level2">
<h2 class="anchored" data-anchor-id="references-to-add">References to Add:</h2>
<ul>
<li></li>
<li><p>Sidney Mintz “Sweetness and Power”</p></li>
<li></li>
<li><p>Plantation archaeology dental studies</p></li>
<li></li>
<li><p>Historical dental health surveys</p></li>
<li></li>
<li><p>Modern sugar and oral health research</p></li>
<li></li>
<li><p>Traditional sweetener studies</p></li>
<li></li>
<li><p>Public health policy analysis</p></li>
<li></li>
</ul>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>